{{ file_header }}
{% if flow_imports %}

{% for import in flow_imports %}
import {{ import }}
{% endfor %}
{% endif %}

/**
 PURPOSE:
 The interface that the Flow will speak to the Context through. Used for informing the Context of
 presentation lifecycle events, as an example.
 */
/// @mockable
{% if node_name == "App" %}
internal protocol {{ node_name }}ContextInterface: Context, SceneListener {}
{% elif node_name == "Scene" %}
internal protocol {{ node_name }}ContextInterface: Context, WindowListener {}
{% elif node_name == "Window" %}
internal protocol {{ node_name }}ContextInterface: Context, RootListener {}
{% else %}
internal protocol {{ node_name }}ContextInterface: Context {}

/**
 PURPOSE:
 The interface of the View used for presenting the View of child Nodes. May inherit additional base
 protocols to add further pre-baked presentation behavior and/or add new methods for custom presentation
 implementation as necessary.
 */
internal protocol {{ node_name }}ViewControllable: {{ view_controllable_type }} {}
{% endif %}

/**
 PURPOSE:
 Responsible for presenting views and starting child Flows, and should not contain business logic.
 */
internal final class {{ node_name }}FlowImp: AbstractFlow
<
    {{ node_name }}ContextInterface,
    {% if node_name == "App" %}
    Void
    {% elif node_name == "Scene" %}
    Window{{ node_name }}ViewControllable
    {% else %}
    {{ node_name }}ViewControllable
    {% endif %}
> {
    {% if node_name == "App" %}

    private let sceneBuilder: SceneBuilder
    {% elif node_name == "Scene" %}

    private let windowBuilder: WindowBuilder
    {% elif node_name == "Window" %}

    private let rootBuilder: RootBuilder
    {% elif flow_properties %}

    {% for property in flow_properties %}
    private let {{ property.name }}: {{ property.type }}
    {% endfor %}
    {% endif %}

    /// The initializer.
    ///
    /// Inject Plugins or Builders into the Flow in order to create sub-Flows.
    /// - Parameters:
    ///   - context: The Context instance
    {% if node_name == "App" %}
    ///   - sceneBuilder: The Scene Builder instance
    internal init(
        context: {{ node_name }}ContextInterface,
        sceneBuilder: SceneBuilder
    ) {
        self.sceneBuilder = sceneBuilder
        super.init(context: context, viewController: ())
    }
    {% elif node_name == "Scene" %}
    ///   - viewController: The View Controller instance
    ///   - windowBuilder: The Window Builder instance
    internal init(
        context: {{ node_name }}ContextInterface,
        viewController: Window{{ node_name }}ViewControllable,
        windowBuilder: WindowBuilder
    ) {
        self.windowBuilder = windowBuilder
        super.init(context: context, viewController: viewController)
    }
    {% elif node_name == "Window" %}
    ///   - viewController: The View Controller instance
    ///   - rootBuilder: The Root Builder instance
    internal init(
        context: {{ node_name }}ContextInterface,
        viewController: {{ node_name }}ViewControllable,
        rootBuilder: RootBuilder
    ) {
        self.rootBuilder = rootBuilder
        super.init(context: context, viewController: viewController)
    }
    {% else %}
    ///   - viewController: The View Controller instance
    {% if flow_properties %}
    {% for property in flow_properties %}
    ///   - {{ property.name }}: The {{ property.type }} instance
    {% endfor %}
    internal init(
    {% else %}
    override internal init(
    {% endif %}
        context: {{ node_name }}ContextInterface,
        viewController: {{ node_name }}ViewControllable{% if flow_properties %}{{ ',' }}
        {% endif %}
        {% for property in flow_properties %}
        {{ property.name }}: {{ property.type }}{% if not forloop.last %}{{ ',' }}
        {% endif %}
        {% endfor +%}
    ) {
        {% for property in flow_properties %}
        self.{{ property.name }} = {{ property.name }}
        {% endfor %}
        super.init(context: context, viewController: viewController)
    }
    {% endif %}

    /// Implement logic to execute when the Flow is started.
    {% if node_name == "Scene" %}
    override internal func didStart() {
        attachWindow()
    }
    {% elif node_name == "Window" %}
    override internal func didStart() {
        attachRoot()
    }
    {% else %}
    override internal func didStart() {}
    {% endif %}
    {% if owns_view or node_name == "Scene" %}

    /// Provides the ``ViewControllable`` instance to the parent `Flow` for display or presentation.
    ///
    /// - Returns: The ``ViewControllable`` instance.
    {% if node_name == "Scene" %}
    internal func getViewController() -> Window{{ node_name }}ViewControllable {
    {% else %}
    internal func getViewController() -> {{ view_controllable_type }} {
    {% endif %}
        viewController
    }
    {% endif %}
    {% if node_name == "Scene" %}

    private func attachWindow() {
        let flow: WindowFlow = windowBuilder.build(withListener: context,
                                                   viewController: viewController.makeWindow())
        attach(starting: flow)
    }
    {% elif node_name == "Window" %}

    private func attachRoot() {
        let flow: RootFlow = rootBuilder.build(withListener: context)
        viewController.present(flow.getViewController())
        attach(starting: flow)
    }
    {% endif %}
}

extension {{ node_name }}FlowImp: {{ node_name }}Flow {}
{% if node_name == "App" %}
extension {{ node_name }}FlowImp: {{ node_name }}FlowInterface {

    internal func attachScene(_ viewController: WindowSceneViewControllable) {
        let flow: SceneFlow = sceneBuilder.build(withListener: context,
                                                 viewController: viewController)
        attach(starting: flow)
    }

    internal func detachScene(_ viewController: WindowSceneViewControllable) {
        subFlows
            .compactMap { $0 as? SceneFlow }
            .filter { $0.getViewController() === viewController }
            .forEach(detach)
    }
}
{% elif node_name == "Root" %}
extension {{ node_name }}FlowImp: {{ node_name }}FlowInterface {

    /// Implement logic to execute when the Root Flow is ready to attach sub-Flows.
    internal func didBecomeReady() {}
}
{% else %}
extension {{ node_name }}FlowImp: {{ node_name }}FlowInterface {}
{% endif %}
