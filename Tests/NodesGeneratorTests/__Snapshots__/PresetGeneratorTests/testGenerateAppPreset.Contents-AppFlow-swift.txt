//
//  Created by <author> on <date>.
//

import Nodes

/// The interface that the Flow will speak to the Context through. Used for informing the Context of
/// presentation lifecycle events, as an example.
/// @mockable
@MainActor
internal protocol AppContextInterface: Context, WindowSceneListener {}

/// Responsible for presenting views and starting child Flows, and should not contain business logic.
internal final class AppFlowImp: AbstractFlow
<
    AppContextInterface,
    Void
> {

    private let windowSceneBuilder: WindowSceneBuilder

    /// The initializer.
    ///
    /// Inject Plugins or Builders into the Flow in order to create sub-Flows.
    internal init(
        context: AppContextInterface,
        windowSceneBuilder: WindowSceneBuilder
    ) {
        self.windowSceneBuilder = windowSceneBuilder
        super.init(context: context, viewController: ())
    }

    /// Implement logic to execute when the Flow is started.
    override internal func didStart() {}
}

extension AppFlowImp: AppFlow {}

extension AppFlowImp: AppFlowInterface {

    internal func attachWindowScene(_ viewController: WindowSceneViewControllable) {
        let flow: WindowSceneFlow = windowSceneBuilder.build(withListener: context,
                                                             viewController: viewController)
        attach(starting: flow)
    }

    internal func detachWindowScene(_ viewController: WindowSceneViewControllable) {
        detach(endingSubFlowsOfType: WindowSceneFlow.self) { $0.getViewController() === viewController }
    }
}
