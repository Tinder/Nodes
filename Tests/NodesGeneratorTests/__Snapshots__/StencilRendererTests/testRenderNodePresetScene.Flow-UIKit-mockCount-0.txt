//<fileHeader>

/// The interface that the Flow will speak to the Context through. Used for informing the Context of
/// presentation lifecycle events, as an example.
/// @mockable
@MainActor
internal protocol WindowSceneContextInterface: Context, WindowListener {}

/// Responsible for presenting views and starting child Flows, and should not contain business logic.
internal final class WindowSceneFlowImp: AbstractFlow
<
    WindowSceneContextInterface,
    WindowSceneViewControllable
> {

    private let windowBuilder: WindowBuilder

    /// The initializer.
    ///
    /// Inject Plugins or Builders into the Flow in order to create sub-Flows.
    internal init(
        context: WindowSceneContextInterface,
        viewController: WindowSceneViewControllable,
        windowBuilder: WindowBuilder
    ) {
        self.windowBuilder = windowBuilder
        super.init(context: context, viewController: viewController)
    }

    /// Implement logic to execute when the Flow is started.
    override internal func didStart() {
        attachWindow()
    }

    /// Provides the ``ViewControllable`` instance to the parent `Flow` for display or presentation.
    internal func getViewController() -> WindowSceneViewControllable {
        viewController
    }

    private func attachWindow() {
        let flow: WindowFlow = windowBuilder.build(withListener: context,
                                                   viewController: viewController.makeWindow())
        attach(starting: flow)
    }
}

extension WindowSceneFlowImp: WindowSceneFlow {}
extension WindowSceneFlowImp: WindowSceneFlowInterface {}
